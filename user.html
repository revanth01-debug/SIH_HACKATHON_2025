<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CivicTrack - User Home</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: white;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .brand {
      font-size: 24px;
      font-weight: bold;
    }
    .nav-links a {
      margin-left: 20px;
      text-decoration: none;
      color: #4fc3f7;
    }
    .filters {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filters select,
    .filters input {
      padding: 8px;
      border: 1px solid #555;
      background-color: #1e1e1e;
      color: white;
      border-radius: 5px;
    }
    .green-outline-btn {
      padding: 8px 15px;
      border: 2px solid #4caf50;
      background: none;
      color: #4caf50;
      border-radius: 20px;
      cursor: pointer;
    }
    .green-outline-btn:hover {
      background: #4caf50;
      color: black;
    }
    .issue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .card {
      background-color: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }
    .card img {
      width: 100%;
      height: auto;
    }
    .card-content {
      padding: 15px;
    }
    .card-content .status {
      color: orange;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .card-content .status.red {
      color: red;
    }
    /* ...other styles (pagination, stats, faq, footer, etc.)... */
  </style>
</head>
<body>
  <div class="container">
    <!-- Navbar -->
    <div class="navbar">
      <span class="brand">CivicTrack</span>
      <div class="nav-links">
        <a href="#" id="myIssuesLink">My Issues</a>
        <a href="#" id="reportIssueLink">Report new issue</a>
      </div>
      <script>
    // --- MIGRATION: Convert old timestamps to ISO format if needed ---
    (function migrateTimestampsToISO() {
      let reports = JSON.parse(localStorage.getItem("reports")) || [];
      let changed = false;
      reports.forEach(r => {
        if (r.timestamp && !/^\d{4}-\d{2}-\d{2}T/.test(r.timestamp)) {
          // Try to parse and convert
          let d = new Date(r.timestamp);
          if (!isNaN(d)) {
            r.timestamp = d.toISOString();
            changed = true;
          }
        }
      });
      if (changed) {
        localStorage.setItem("reports", JSON.stringify(reports));
      }
    })();
        // Make nav links functional
        document.getElementById('myIssuesLink').onclick = function(e) {
          e.preventDefault();
          const issuesSection = document.getElementById('issueContainer');
          if (issuesSection) {
            issuesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        };
        document.getElementById('reportIssueLink').onclick = function(e) {
          e.preventDefault();
          window.location.href = 'issue.html';
        };
      </script>
    </div>

    <!-- Filters (optional, can be removed if not needed) -->
     <!-- Category and Status Selection -->
    <div style="margin: 24px 0; display: flex; gap: 40px; flex-wrap: wrap; align-items: center;">
       <div>
         <label for="categorySelect" style="color: #4fc3f7; font-weight: bold;">Select Category:</label>
         <select id="categorySelect" style="padding: 8px; border-radius: 6px; margin-left: 8px;">
           <option value="">All Categories</option>
           <option value="Streetlight">Streetlight</option>
           <option value="Garbage">Garbage</option>
           <option value="Pothole">Pothole</option>
           <option value="Water Leakage">Water Leakage</option>
           <option value="Road">Road</option>
           <option value="Drain">Drain</option>
           <option value="Parking">Parking</option>
           <option value="Tree">Tree</option>
           <option value="Flooding">Flooding</option>
         </select>
       </div>
       <div>
         <label for="statusSelect" style="color: #4fc3f7; font-weight: bold;">Select Status:</label>
         <select id="statusSelect" style="padding: 8px; border-radius: 6px; margin-left: 8px;">
           <option value="">All Statuses</option>
           <option value="Reported">Reported</option>
           <option value="In Progress">In Progress</option>
           <option value="Resolved">Resolved</option>
           <option value="Closed">Closed</option>
         </select>
       </div>
  <button id="searchBtn" class="green-outline-btn" style="height:40px;align-self:flex-end;">Search</button>
  <button id="goHomeBtn" class="green-outline-btn" style="height:40px;align-self:flex-end;margin-left:10px;">Go Back to Home Page</button>
     </div>
     <script>
       // Filtering logic for category and status
       function renderUserIssues(issues) {
         const container = document.getElementById("issueContainer");
         container.innerHTML = "";
         if (issues.length === 0) {
           container.innerHTML = '<div style="color:#888;text-align:center;padding:40px;">No issues found.</div>';
         } else {
           issues.forEach((r) => {
             const card = document.createElement("div");
             card.className = "issue-card card";
             let approvalStatus = (r.approved === true)
               ? '<span style="color:#4caf50;font-weight:600;">Government Approved</span>'
               : '<span style="color:#e67e22;font-weight:600;">Pending Government Approval</span>';
             card.innerHTML = `
               <h3>üìç ${r.address || r.location || "-"}</h3>
               <p><strong>Category:</strong> ${r.category}</p>
               <p><strong>Desc:</strong> ${r.description}</p>
               <p><strong>Status:</strong> ${r.status || "Reported"}</p>
               <p><strong>Time:</strong> ${r.timestamp || "-"}</p>
               <p><strong>Approval:</strong> ${approvalStatus}</p>
               ${(r.photos && r.photos.length) ? r.photos.map((p) => `<img src="${p}" width="150" style="margin: 5px;" />`).join("") : ""}
               <hr />
             `;
             container.appendChild(card);
           });
         }
       }
       document.getElementById("searchBtn").onclick = function() {
         const category = document.getElementById("categorySelect").value;
         const status = document.getElementById("statusSelect").value;
         const userProfileStr = localStorage.getItem("loggedInUser");
         const userProfile = userProfileStr ? JSON.parse(userProfileStr) : null;
         const reports = JSON.parse(localStorage.getItem("reports")) || [];
         let userIssues = userProfile ? reports.filter(r => r.email === userProfile.email) : [];
         if (category) {
           userIssues = userIssues.filter(r => r.category === category);
         }
         if (status) {
           userIssues = userIssues.filter(r => (r.status || "Reported") === status);
         }
         renderUserIssues(userIssues);
       };
       // Go Back to Home Page button
       document.getElementById("goHomeBtn").onclick = function() {
         window.location.href = "index.html";
       };
     </script>

    <!-- User Profile -->
    <div id="userProfileBox" style="background:#fff;color:#222;padding:16px 24px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.12);margin:20px 0;">
      <!-- Filled by JS -->
    </div>
    <!-- Issue Grid -->
    <div class="issue-grid" id="issueContainer">
      <!-- User's issues will be loaded here by JS -->
    </div>

    <!-- Dashboard Summary (now at bottom) -->
    <div id="dashboardSummary" style="background:#23234a;color:#fff;padding:18px 24px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.12);margin:30px 0 10px 0;">
      <!-- Filled by JS -->
    </div>

    <!-- Issues per Month Chart -->
    <div style="background:#fff;padding:24px 18px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.10);margin:30px 0 30px 0;">
      <h3 style="color:#23234a;text-align:center;margin-bottom:18px;">Issues Reported Per Month</h3>
      <div style="width:100%;max-width:600px;margin:0 auto;">
        <canvas id="issuesPerMonthChart" height="260" style="min-height:220px;max-height:320px;"></canvas>
      </div>
    </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Pagination (optional, can be removed if not needed) -->
    <div class="pagination">
      <button>&lt;</button>
      <button class="active">1</button>
      <button class="active">2</button>
      <button class="active">3</button>
      <button class="active">4</button>
      <button class="active">...</button>
      <button class="active">11</button>
      <button class="active">&gt;</button>
    </div>
  </div>
  <!-- ...other sections like stats, faq, footer... -->

  <script>
    // Show user profile, only their issues, and dashboard summary
    window.onload = function () {
      // --- Issues Per Month Chart ---
      let issuesChartInstance = null;
      function renderIssuesPerMonthChart(issues) {
        // Count issues per month and category (YYYY-MM)
        const monthCatCounts = {};
        const allCategories = new Set();
        issues.forEach(r => {
          if (!r.timestamp) return;
          let d = new Date(r.timestamp);
          if (isNaN(d)) d = new Date(Date.parse(r.timestamp));
          if (isNaN(d)) return;
          const ym = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
          if (!monthCatCounts[ym]) monthCatCounts[ym] = {};
          if (!monthCatCounts[ym][r.category]) monthCatCounts[ym][r.category] = 0;
          monthCatCounts[ym][r.category]++;
          allCategories.add(r.category);
        });
        // Sort months
        const months = Object.keys(monthCatCounts).sort();
        // Category color palette
        const catColors = [
          '#4fc3f7','#6a5acd','#ffb347','#e67e22','#ff6384','#36a2eb','#43a047','#f44336','#8e44ad','#00bcd4'
        ];
        const catList = Array.from(allCategories);
        // Prepare datasets: one per category
        const datasets = catList.map((cat, i) => ({
          label: cat,
          data: months.map(m => monthCatCounts[m][cat] || 0),
          backgroundColor: catColors[i % catColors.length],
          borderRadius: 6,
          maxBarThickness: 40
        }));
        // Format labels as "MMM YYYY"
        const labels = months.map(m => {
          const [y,mo] = m.split('-');
          return new Date(y, mo-1).toLocaleString('default', { month: 'short', year: 'numeric' });
        });
        // Draw chart (horizontal bar: x = count, y = month)
        const ctx = document.getElementById('issuesPerMonthChart').getContext('2d');
        // Clear previous chart if exists
        if (issuesChartInstance) {
          issuesChartInstance.destroy();
        }
        if (labels.length === 0 || datasets.length === 0 || datasets.every(ds => ds.data.every(v => v === 0))) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = '18px Poppins, Arial, sans-serif';
          ctx.fillStyle = '#888';
          ctx.textAlign = 'center';
          ctx.fillText('No data to display', ctx.canvas.width/2, ctx.canvas.height/2);
          return;
        }
        issuesChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            indexAxis: 'y',
            plugins: {
              legend: { display: true, position: 'top' }
            },
            scales: {
              x: { beginAtZero: true, title: { display: true, text: 'No. of Issues Reported' }, ticks: { stepSize: 1 } },
              y: { title: { display: true, text: 'Month' } }
            },
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
      const userProfileStr = localStorage.getItem("loggedInUser");
      const userProfile = userProfileStr ? JSON.parse(userProfileStr) : null;
      const profileDiv = document.getElementById("userProfileBox");
      if (userProfile && profileDiv) {
        profileDiv.innerHTML = `
          <strong>üë§ Profile</strong><br>
          <b>Name:</b> ${userProfile.username}<br>
          <b>Email:</b> ${userProfile.email}<br>
          <b>Phone:</b> ${userProfile.phone}
        `;
      }
      const reports = JSON.parse(localStorage.getItem("reports")) || [];
      const container = document.getElementById("issueContainer");
      container.innerHTML = "";
      // Filter issues by logged-in user email
      let userIssues = userProfile ? reports.filter(r => r.email === userProfile.email) : [];
      userIssues = userIssues.reverse();

      // --- Dashboard Summary ---
      const summaryDiv = document.getElementById("dashboardSummary");
      if (userIssues.length === 0) {
        summaryDiv.innerHTML = '<span style="color:#aaa;">No issues reported yet.</span>';
      } else {
        // Count per category
        const counts = {};
        userIssues.forEach(r => {
          if (!counts[r.category]) counts[r.category] = 0;
          counts[r.category]++;
        });
        // Find most repeated
        let maxCat = null, maxCount = 0;
        let percentHTML = '';
        Object.entries(counts).forEach(([cat, count]) => {
          const percent = ((count / userIssues.length) * 100).toFixed(1);
          percentHTML += `<span style="margin-right:18px;">${cat}: <b>${percent}%</b></span>`;
          if (count > maxCount) { maxCount = count; maxCat = cat; }
        });
        summaryDiv.innerHTML = `
          <div style="font-size:1.1rem;margin-bottom:6px;">Issue Category Percentages:</div>
          <div style="margin-bottom:8px;">${percentHTML}</div>
          <div style="font-size:1.1rem;">Most Reported Issue: <b style="color:#4fc3f7;">${maxCat}</b> (${maxCount} times)</div>
        `;
      }

      // --- Render Issues ---
      if (userIssues.length === 0) {
        container.innerHTML = '<div style="color:#888;text-align:center;padding:40px;">No issues reported yet.</div>';
      } else {
        userIssues.forEach((r) => {
          const card = document.createElement("div");
          card.className = "issue-card card";
          let approvalStatus = (r.approved === true)
            ? '<span style="color:#4caf50;font-weight:600;">Government Approved</span>'
            : '<span style="color:#e67e22;font-weight:600;">Pending Government Approval</span>';
          card.innerHTML = `
            <h3>üìç ${r.address || r.location || "-"}</h3>
            <p><strong>Category:</strong> ${r.category}</p>
            <p><strong>Desc:</strong> ${r.description}</p>
            <p><strong>Status:</strong> ${r.status || "Reported"}</p>
            <p><strong>Time:</strong> ${r.timestamp || "-"}</p>
            <p><strong>Approval:</strong> ${approvalStatus}</p>
            ${(r.photos && r.photos.length) ? r.photos.map((p) => `<img src="${p}" width="150" style="margin: 5px;" />`).join("") : ""}
            <hr />
          `;
          container.appendChild(card);
        });
      }
      // Draw issues per month chart
      renderIssuesPerMonthChart(userIssues);
    };
  </script>
</body>
</html>